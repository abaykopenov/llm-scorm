<!DOCTYPE html>
<html lang="{{ language }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ sco_title }} - {{ course_title }}</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .final-quiz-title {
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 1.5em;
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 10px;
        }
    </style>
</head>

<body>
    <!-- Sidebar Toggle (mobile) -->
    <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="–ú–µ–Ω—é">‚ò∞</button>

    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>{{ course_title }}</h3>
                <h1 style="font-size:1.1em; margin-top:10px">{{ sco_title }}</h1>
            </div>
            <nav class="sidebar-nav" id="sidebarNav">
                {% for screen in screens %}
                <div class="nav-item{% if loop.first %} active{% endif %}" data-page="{{ loop.index0 }}"
                    onclick="goToPage({{ loop.index0 }})">
                    <span class="nav-dot"></span>
                    <span>{{ screen.title }}</span>
                </div>
                {% endfor %}
                {% if knowledge_check %}
                <div class="nav-item" data-page="{{ screens | length }}" onclick="goToPage({{ screens | length }})">
                    <span class="nav-dot"></span>
                    <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π</span>
                </div>
                {% endif %}
            </nav>
            <div class="sidebar-footer">
                <div class="progress-text">
                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å SCO</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar"></div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Screens (Theory) -->
            {% for screen in screens %}
            {% set page_idx = loop.index0 %}
            <div class="page-container" id="page-{{ page_idx }}" style="{% if not loop.first %}display:none{% endif %}">
                <h2 class="page-title">{{ screen.title }}</h2>

                {% for block in screen.blocks %}
                {% if block.type == 'text' %}
                <!-- Text Block -->
                <div class="block">
                    <div class="block-title">
                        <span class="block-icon text-icon">üìñ</span>
                        {{ block.title }}
                    </div>
                    <div class="block-body">
                        {{ block.body }}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}

            <!-- Knowledge Check (Quiz) -->
            {% if knowledge_check %}
            {% set page_idx = screens | length %}
            <div class="page-container" id="page-{{ page_idx }}" style="display:none">
                <h2 class="page-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π</h2>

                {% for block in knowledge_check %}
                {% set block_idx = loop.index0 %}
                {% set quiz_id = "quiz-" ~ block_idx %}

                {% if block.type == 'mcq' %}
                <!-- MCQ Block -->
                <div class="block quiz-block" id="{{ quiz_id }}">
                    <div class="block-title">
                        <span class="block-icon quiz-icon">‚ùì</span>
                        {{ block.title }}
                    </div>
                    <p class="quiz-question">{{ block.body }}</p>
                    <div class="quiz-options">
                        {% for opt in block.options %}
                        <div class="quiz-option" data-correct="{{ opt.correct | lower }}" data-quiz="{{ quiz_id }}"
                            onclick="selectOption(this)">
                            <span class="quiz-radio"></span>
                            <span>{{ opt.text }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="quiz-submit" disabled onclick="submitQuiz('{{ quiz_id }}', 'mcq')"
                        id="btn-{{ quiz_id }}">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
                    </button>
                    <div class="quiz-feedback" id="fb-{{ quiz_id }}" data-correct="{{ block.feedback_correct }}"
                        data-incorrect="{{ block.feedback_incorrect }}">
                    </div>
                </div>

                {% elif block.type == 'truefalse' %}
                <!-- True/False Block -->
                <div class="block quiz-block" id="{{ quiz_id }}">
                    <div class="block-title">
                        <span class="block-icon quiz-icon">‚úÖ</span>
                        {{ block.title }}
                    </div>
                    <p class="quiz-question">{{ block.body }}</p>
                    <div class="tf-options">
                        <button class="tf-btn" data-value="true"
                            data-correct="{{ (block.correct_answer == true) | lower }}" data-quiz="{{ quiz_id }}"
                            onclick="selectTF(this)">
                            –í–µ—Ä–Ω–æ
                        </button>
                        <button class="tf-btn" data-value="false"
                            data-correct="{{ (block.correct_answer == false) | lower }}" data-quiz="{{ quiz_id }}"
                            onclick="selectTF(this)">
                            –ù–µ–≤–µ—Ä–Ω–æ
                        </button>
                    </div>
                    <button class="quiz-submit" disabled onclick="submitQuiz('{{ quiz_id }}', 'truefalse')"
                        id="btn-{{ quiz_id }}">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
                    </button>
                    <div class="quiz-feedback" id="fb-{{ quiz_id }}" data-correct="{{ block.feedback_correct }}"
                        data-incorrect="{{ block.feedback_incorrect }}">
                    </div>
                </div>

                {% elif block.type == 'fillin' %}
                <!-- Fill-in-the-Blank Block -->
                <div class="block quiz-block" id="{{ quiz_id }}">
                    <div class="block-title">
                        <span class="block-icon fillin-icon">‚úèÔ∏è</span>
                        {{ block.title }}
                    </div>
                    <p class="quiz-question">{{ block.body }}</p>
                    <div class="fillin-input-wrap">
                        <input type="text" class="fillin-input" id="input-{{ quiz_id }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..."
                            data-correct="{{ block.correct_answer }}"
                            data-alternatives="{{ block.accept_alternatives | default([]) | join('|||') }}"
                            onkeyup="fillinKeyup(event, '{{ quiz_id }}')" />
                    </div>
                    <button class="quiz-submit" disabled onclick="submitQuiz('{{ quiz_id }}', 'fillin')"
                        id="btn-{{ quiz_id }}">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
                    </button>
                    <div class="quiz-feedback" id="fb-{{ quiz_id }}" data-correct="{{ block.feedback_correct }}"
                        data-incorrect="{{ block.feedback_incorrect }}">
                    </div>
                </div>

                {% elif block.type == 'matching' %}
                <!-- Matching Block -->
                <div class="block quiz-block" id="{{ quiz_id }}">
                    <div class="block-title">
                        <span class="block-icon matching-icon">üîó</span>
                        {{ block.title }}
                    </div>
                    <p class="quiz-question">{{ block.body }}</p>
                    <div class="matching-container">
                        <div class="matching-left">
                            {% for pair in block.pairs %}
                            <div class="matching-item-left" data-pair-idx="{{ loop.index0 }}">
                                {{ pair.left }}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="matching-right" id="mr-{{ quiz_id }}">
                            {% set matching_pairs = block.pairs | reverse | list %}
                            {% for pair in matching_pairs %}
                            <div class="matching-item-right" draggable="true" data-quiz="{{ quiz_id }}">
                                {{ pair.right }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <button class="quiz-submit" onclick="submitQuiz('{{ quiz_id }}', 'matching')"
                        id="btn-{{ quiz_id }}">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
                    </button>
                    <div class="quiz-feedback" id="fb-{{ quiz_id }}" data-correct="{{ block.feedback_correct }}"
                        data-incorrect="{{ block.feedback_incorrect }}" data-pairs="{{ block.pairs | tojson | e }}">
                    </div>
                </div>

                {% elif block.type == 'ordering' %}
                <!-- Ordering Block -->
                <div class="block quiz-block" id="{{ quiz_id }}">
                    <div class="block-title">
                        <span class="block-icon ordering-icon">üìã</span>
                        {{ block.title }}
                    </div>
                    <p class="quiz-question">{{ block.body }}</p>
                    <div class="ordering-list" id="ol-{{ quiz_id }}">
                        {% set ordering_items = block['items'] | reverse | list %}
                        {% for item in ordering_items %}
                        <div class="ordering-item" draggable="true" data-quiz="{{ quiz_id }}">
                            <span class="ordering-handle">‚†ø</span>
                            <span class="ordering-text">{{ item }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="quiz-submit" onclick="submitQuiz('{{ quiz_id }}', 'ordering')"
                        id="btn-{{ quiz_id }}">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫
                    </button>
                    <div class="quiz-feedback" id="fb-{{ quiz_id }}" data-correct="{{ block.feedback_correct }}"
                        data-incorrect="{{ block.feedback_incorrect }}"
                        data-correct-order="{{ block['items'] | tojson | e }}">
                    </div>
                </div>
                {% endif %}
                {% endfor %}

                <button class="nav-btn primary" id="btnFinishSCO" style="margin-top:20px; width:100%"
                    onclick="showCompletion()">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç SCO</button>
            </div>
            {% endif %}

            <!-- Completion Screen -->
            <div class="completion-screen" id="completionScreen">
                <div class="completion-icon">üéâ</div>
                <h2 class="completion-title">–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω!</h2>
                <p class="completion-text">–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–∫—É –≤ –ø–ª–µ–µ—Ä–µ –∫—É—Ä—Å–∞.</p>
                <div class="completion-score" id="finalScore">0%</div>
                <p class="completion-score-label">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏–π</p>
            </div>

            <!-- Bottom padding for nav footer -->
            <div style="height: 80px;"></div>
        </main>
    </div>

    <!-- Navigation Footer -->
    <div class="nav-footer">
        <button class="nav-btn" id="btnPrev" onclick="prevPage()" disabled>
            ‚Üê –ù–∞–∑–∞–¥
        </button>
        {% set total_pages = screens | length + (1 if knowledge_check else 0) %}
        {% if total_pages == 0 %} {% set total_pages = 1 %} {% endif %}
        <span class="page-indicator" id="pageIndicator">1 / {{ total_pages }}</span>
        <button class="nav-btn primary" id="btnNext" onclick="nextPage()">
            –î–∞–ª–µ–µ ‚Üí
        </button>
    </div>

    <script src="scorm_api.js"></script>
    <script>
        (function () {
            "use strict";

            var totalPages = {{ total_pages }
        };
        var currentPage = 0;
        var visitedPages = new Set([0]);
        var quizResults = {};
        var totalQuizzes = 0;
        var correctQuizzes = 0;
        var passingScore = {{ passing_score }};

        document.querySelectorAll('.quiz-block').forEach(function () { totalQuizzes++; });

        // Initialize SCORM
        SCORM.initialize();

        // Restore location
        var saved = SCORM.getLocation();
        if (saved && !isNaN(parseInt(saved))) {
            goToPage(parseInt(saved));
        }

        window.goToPage = function (idx) {
            if (idx < 0 || idx >= totalPages) return;

            var cur = document.getElementById('page-' + currentPage);
            if (cur) cur.style.display = 'none';

            if (idx >= totalPages) {
                showCompletion();
                return;
            }

            var target = document.getElementById('page-' + idx);
            if (target) target.style.display = '';

            document.getElementById('completionScreen').classList.remove('show');

            currentPage = idx;
            visitedPages.add(idx);

            updateNav();
            updateProgress();
            SCORM.setLocation(String(idx));
            SCORM.commit();

            document.getElementById('sidebar').classList.remove('open');
        };

        window.nextPage = function () {
            if (currentPage < totalPages - 1) {
                goToPage(currentPage + 1);
            } else {
                showCompletion();
            }
        };

        window.prevPage = function () {
            if (currentPage > 0) {
                goToPage(currentPage - 1);
            }
        };

        window.toggleSidebar = function () {
            document.getElementById('sidebar').classList.toggle('open');
        };

        function updateNav() {
            var btnPrev = document.getElementById('btnPrev');
            var btnNext = document.getElementById('btnNext');
            if (btnPrev) btnPrev.disabled = currentPage === 0;
            if (btnNext) btnNext.textContent = currentPage === totalPages - 1 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å SC0 ‚úì' : '–î–∞–ª–µ–µ ‚Üí';
            var ind = document.getElementById('pageIndicator');
            if (ind) ind.textContent = (currentPage + 1) + ' / ' + totalPages;

            document.querySelectorAll('.nav-item').forEach(function (el, i) {
                el.classList.toggle('active', i === currentPage);
                el.classList.toggle('completed', visitedPages.has(i) && i !== currentPage);
            });
        }

        function updateProgress() {
            var pct = Math.round((visitedPages.size / totalPages) * 100);
            var pb = document.getElementById('progressBar');
            var pt = document.getElementById('progressPercent');
            if (pb) pb.style.width = pct + '%';
            if (pt) pt.textContent = pct + '%';

            if (totalQuizzes === 0) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –∫–≤–∏–∑–æ–≤, —Ç–æ —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–º –ø–æ –ø—Ä–æ—á—Ç–µ–Ω–∏—é 100%
                if (pct >= 100) {
                    SCORM.setLessonStatus('completed');
                    SCORM.setScore(100);
                } else {
                    SCORM.setLessonStatus('incomplete');
                }
            }
        }

        // Quiz logic: MCQ + TrueFalse
        window.selectOption = function (el) {
            var quizId = el.getAttribute('data-quiz');
            if (quizResults[quizId] !== undefined) return;

            var options = el.parentElement.querySelectorAll('.quiz-option');
            options.forEach(function (o) { o.classList.remove('selected'); });
            el.classList.add('selected');

            var btn = document.getElementById('btn-' + quizId);
            if (btn) btn.disabled = false;
        };

        window.selectTF = function (el) {
            var quizId = el.getAttribute('data-quiz');
            if (quizResults[quizId] !== undefined) return;

            var btns = el.parentElement.querySelectorAll('.tf-btn');
            btns.forEach(function (b) { b.classList.remove('selected'); });
            el.classList.add('selected');

            var btn = document.getElementById('btn-' + quizId);
            if (btn) btn.disabled = false;
        };

        window.fillinKeyup = function (event, quizId) {
            if (quizResults[quizId] !== undefined) return;
            var input = document.getElementById('input-' + quizId);
            var btn = document.getElementById('btn-' + quizId);
            if (btn) btn.disabled = !input.value.trim();
            if (event.key === 'Enter' && input.value.trim()) {
                submitQuiz(quizId, 'fillin');
            }
        };

        // DragDrop code skipped for brevity, copy pasted basically
        var dragSrcEl = null;
        function handleDragStart(e) { dragSrcEl = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; this.classList.add('drag-over'); return false; }
        function handleDragLeave() { this.classList.remove('drag-over'); }
        function handleDrop(e) {
            e.stopPropagation(); e.preventDefault(); this.classList.remove('drag-over');
            if (dragSrcEl !== this) {
                var parent = this.parentNode; var allItems = Array.from(parent.children);
                var srcIdx = allItems.indexOf(dragSrcEl); var dstIdx = allItems.indexOf(this);
                if (srcIdx < dstIdx) parent.insertBefore(dragSrcEl, this.nextSibling);
                else parent.insertBefore(dragSrcEl, this);
            }
            return false;
        }
        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.ordering-item, .matching-item-right').forEach(function (el) { el.classList.remove('drag-over'); });
        }
        function initDragDrop() {
            document.querySelectorAll('.ordering-item, .matching-item-right').forEach(function (item) {
                item.addEventListener('dragstart', handleDragStart); item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave); item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }
        initDragDrop();

        window.submitQuiz = function (quizId, type) {
            if (quizResults[quizId] !== undefined) return;
            var block = document.getElementById(quizId);
            var isCorrect = false;

            if (type === 'mcq') {
                var selected = block.querySelector('.quiz-option.selected');
                if (!selected) return;
                isCorrect = selected.getAttribute('data-correct') === 'true';
                block.querySelectorAll('.quiz-option').forEach(function (o) {
                    o.classList.add('disabled');
                    if (o.getAttribute('data-correct') === 'true') o.classList.add('correct');
                    else if (o === selected && !isCorrect) o.classList.add('incorrect');
                });
            } else if (type === 'truefalse') {
                var selected = block.querySelector('.tf-btn.selected');
                if (!selected) return;
                isCorrect = selected.getAttribute('data-correct') === 'true';
                block.querySelectorAll('.tf-btn').forEach(function (b) {
                    b.classList.add('disabled');
                    if (b.getAttribute('data-correct') === 'true') b.classList.add('correct');
                    else if (b === selected && !isCorrect) b.classList.add('incorrect');
                });
            } else if (type === 'fillin') {
                var input = document.getElementById('input-' + quizId);
                var userAnswer = input.value.trim().toLowerCase();
                var correctAnswer = input.getAttribute('data-correct').toLowerCase();
                var alternatives = input.getAttribute('data-alternatives');
                var acceptedAnswers = [correctAnswer];
                if (alternatives) alternatives.split('|||').forEach(function (a) { if (a.trim()) acceptedAnswers.push(a.trim().toLowerCase()); });
                isCorrect = acceptedAnswers.indexOf(userAnswer) !== -1;
                input.disabled = true; input.classList.add(isCorrect ? 'correct' : 'incorrect');
            } else if (type === 'matching') {
                var fb = document.getElementById('fb-' + quizId); var pairsData = JSON.parse(fb.getAttribute('data-pairs'));
                var rightItems = block.querySelectorAll('.matching-item-right'); var allCorrect = true;
                rightItems.forEach(function (item, idx) {
                    if (item.textContent.trim() !== pairsData[idx].right.trim()) { allCorrect = false; item.classList.add('incorrect'); }
                    else { item.classList.add('correct'); }
                    item.setAttribute('draggable', 'false'); item.classList.add('disabled');
                });
                isCorrect = allCorrect;
            } else if (type === 'ordering') {
                var fb = document.getElementById('fb-' + quizId); var correctOrder = JSON.parse(fb.getAttribute('data-correct-order'));
                var items = block.querySelectorAll('.ordering-item'); var allCorrect = true;
                items.forEach(function (item, idx) {
                    if (item.querySelector('.ordering-text').textContent.trim() !== correctOrder[idx].trim()) { allCorrect = false; item.classList.add('incorrect'); }
                    else { item.classList.add('correct'); }
                    item.setAttribute('draggable', 'false'); item.classList.add('disabled');
                });
                isCorrect = allCorrect;
            }

            quizResults[quizId] = isCorrect;
            if (isCorrect) correctQuizzes++;

            var fb = document.getElementById('fb-' + quizId);
            if (fb) {
                fb.textContent = isCorrect ? fb.getAttribute('data-correct') : fb.getAttribute('data-incorrect');
                fb.className = 'quiz-feedback show ' + (isCorrect ? 'correct' : 'incorrect');
            }

            var btn = document.getElementById('btn-' + quizId);
            if (btn) btn.disabled = true;

            if (totalQuizzes > 0) {
                var score = Math.round((correctQuizzes / totalQuizzes) * 100);
                SCORM.setScore(score);
                // Pass status based on mastery score
                if (Object.keys(quizResults).length === totalQuizzes) {
                    if (score >= passingScore) SCORM.setLessonStatus('passed');
                    else SCORM.setLessonStatus('failed');
                }
            }
            SCORM.commit();
        };

        window.showCompletion = function () {
            var pagesArr = document.querySelectorAll('.page-container');
            pagesArr.forEach(function (el) { el.style.display = 'none'; });

            var score = totalQuizzes > 0 ? Math.round((correctQuizzes / totalQuizzes) * 100) : 100;
            var finalScoreEl = document.getElementById('finalScore');
            if (finalScoreEl) finalScoreEl.textContent = score + '%';

            var compScreen = document.getElementById('completionScreen');
            if (compScreen) compScreen.classList.add('show');

            SCORM.setScore(score);
            if (totalQuizzes > 0) {
                if (score >= passingScore) SCORM.setLessonStatus('passed');
                else SCORM.setLessonStatus('failed');
            } else {
                SCORM.setLessonStatus('completed');
            }
            SCORM.commit();
        }

        window.addEventListener('beforeunload', function () {
            SCORM.finish();
        });

        updateNav();
        updateProgress();
        }) ();
    </script>
</body>

</html>