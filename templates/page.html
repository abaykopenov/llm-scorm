<!DOCTYPE html>
<html lang="{{ language }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - {{ page.title }}</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â–∏–µ */
        body {
            padding: 20px;
        }

        .page-container {
            display: block;
        }

        .completion-screen {
            display: none;
        }
    </style>
</head>

<body>
    <div class="app" style="margin: 0; padding: 0;">
        <main class="main-content" style="margin: 0; padding: 0;">
            <div class="page-container" id="page-0">
                <h2 class="page-title">{{ page.title }}</h2>

                {% for block in page.blocks %}
                {% set block_idx = loop.index0 %}
                {% set quiz_id = "quiz-0-" ~ block_idx %}
                {% if block.type == 'text' %}
                <!-- Text Block -->
                <div class="block">
                    <div class="block-title">
                        <span class="block-icon text-icon">üìñ</span>
                        {{ block.title }}
                    </div>
                    <div class="block-body">
                        {{ block.body }}
                    </div>
                </div>

                {% elif block.type == 'mcq' %}
                <!-- MCQ Block -->
                <div class="block quiz-block" id="{{ quiz_id }}">
                    <div class="block-title">
                        <span class="block-icon quiz-icon">‚ùì</span>
                        {{ block.title }}
                    </div>
                    <p class="quiz-question">{{ block.body }}</p>
                    <div class="quiz-options">
                        {% for opt in block.options %}
                        <div class="quiz-option" data-correct="{{ opt.correct | lower }}" data-quiz="{{ quiz_id }}"
                            onclick="selectOption(this)">
                            <span class="quiz-radio"></span>
                            <span>{{ opt.text }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="quiz-submit" disabled onclick="submitQuiz('{{ quiz_id }}', 'mcq')"
                        id="btn-{{ quiz_id }}">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
                    </button>
                    <div class="quiz-feedback" id="fb-{{ quiz_id }}" data-correct="{{ block.feedback_correct }}"
                        data-incorrect="{{ block.feedback_incorrect }}">
                    </div>
                </div>

                {% elif block.type == 'truefalse' %}
                <!-- True/False Block -->
                <div class="block quiz-block" id="{{ quiz_id }}">
                    <div class="block-title">
                        <span class="block-icon quiz-icon">‚úÖ</span>
                        {{ block.title }}
                    </div>
                    <p class="quiz-question">{{ block.body }}</p>
                    <div class="tf-options">
                        <button class="tf-btn" data-value="true"
                            data-correct="{{ (block.correct_answer == true) | lower }}" data-quiz="{{ quiz_id }}"
                            onclick="selectTF(this)">
                            –í–µ—Ä–Ω–æ
                        </button>
                        <button class="tf-btn" data-value="false"
                            data-correct="{{ (block.correct_answer == false) | lower }}" data-quiz="{{ quiz_id }}"
                            onclick="selectTF(this)">
                            –ù–µ–≤–µ—Ä–Ω–æ
                        </button>
                    </div>
                    <button class="quiz-submit" disabled onclick="submitQuiz('{{ quiz_id }}', 'truefalse')"
                        id="btn-{{ quiz_id }}">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
                    </button>
                    <div class="quiz-feedback" id="fb-{{ quiz_id }}" data-correct="{{ block.feedback_correct }}"
                        data-incorrect="{{ block.feedback_incorrect }}">
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!-- Bottom padding -->
            <div style="height: 80px;"></div>
        </main>
    </div>

    <!-- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è multi-SCO -->
    <div class="nav-footer">
        <button class="nav-btn primary" id="btnFinishPage" onclick="finishPage()">
            –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚úì
        </button>
    </div>

    <script src="scorm_api.js"></script>
    <script>
        (function () {
            "use strict";

            var quizResults = {};
            var totalQuizzes = 0;
            var correctQuizzes = 0;

            // Count total quizzes
            document.querySelectorAll('.quiz-block').forEach(function () { totalQuizzes++; });

            // Initialize SCORM
            SCORM.initialize();

            // –ï—Å–ª–∏ –Ω–µ—Ç –∫–≤–∏–∑–æ–≤, —Å—Ä–∞–∑—É –≤—ã—Å—Ç–∞–≤–ª—è–µ–º incomplete, –∂–¥–µ–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
            SCORM.setLessonStatus("incomplete");

            // ------------------------------------------------------------------
            // Quiz logic
            // ------------------------------------------------------------------
            window.selectOption = function (el) {
                var quizId = el.getAttribute('data-quiz');
                if (quizResults[quizId] !== undefined) return;

                var options = el.parentElement.querySelectorAll('.quiz-option');
                options.forEach(function (o) { o.classList.remove('selected'); });
                el.classList.add('selected');

                var btn = document.getElementById('btn-' + quizId);
                if (btn) btn.disabled = false;
            };

            window.selectTF = function (el) {
                var quizId = el.getAttribute('data-quiz');
                if (quizResults[quizId] !== undefined) return;

                var btns = el.parentElement.querySelectorAll('.tf-btn');
                btns.forEach(function (b) { b.classList.remove('selected'); });
                el.classList.add('selected');

                var btn = document.getElementById('btn-' + quizId);
                if (btn) btn.disabled = false;
            };

            window.submitQuiz = function (quizId, type) {
                if (quizResults[quizId] !== undefined) return;

                var block = document.getElementById(quizId);
                var isCorrect = false;
                var studentResponseStr = '';

                if (type === 'mcq') {
                    var selected = block.querySelector('.quiz-option.selected');
                    if (!selected) return;
                    isCorrect = selected.getAttribute('data-correct') === 'true';

                    // –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                    studentResponseStr = selected.textContent.trim() || 'Choice';

                    // Mark options
                    block.querySelectorAll('.quiz-option').forEach(function (o) {
                        o.classList.add('disabled');
                        if (o.getAttribute('data-correct') === 'true') {
                            o.classList.add('correct');
                        } else if (o === selected && !isCorrect) {
                            o.classList.add('incorrect');
                        }
                    });
                } else {
                    var selected = block.querySelector('.tf-btn.selected');
                    if (!selected) return;
                    isCorrect = selected.getAttribute('data-correct') === 'true';

                    var val = selected.getAttribute('data-value');
                    studentResponseStr = val === 'true' ? 't' : 'f';

                    block.querySelectorAll('.tf-btn').forEach(function (b) {
                        b.classList.add('disabled');
                        if (b.getAttribute('data-correct') === 'true') {
                            b.classList.add('correct');
                        } else if (b === selected && !isCorrect) {
                            b.classList.add('incorrect');
                        }
                    });
                }

                quizResults[quizId] = isCorrect;
                if (isCorrect) correctQuizzes++;

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å–∫–∏ –≤ LMS (interactions)
                var interactionType = type === 'mcq' ? 'choice' : 'true-false';
                var interactionResult = isCorrect ? 'correct' : 'wrong';
                try {
                    SCORM.recordInteraction(quizId, interactionType, studentResponseStr, interactionResult);
                } catch (e) {
                    console.log("[SCORM] error recording interaction:", e);
                }

                // Feedback
                var fb = document.getElementById('fb-' + quizId);
                if (fb) {
                    fb.textContent = isCorrect ? fb.getAttribute('data-correct') : fb.getAttribute('data-incorrect');
                    fb.className = 'quiz-feedback show ' + (isCorrect ? 'correct' : 'incorrect');
                }

                // Disable submit
                var btn = document.getElementById('btn-' + quizId);
                if (btn) btn.disabled = true;

                updateScore();
            };

            function updateScore() {
                if (totalQuizzes > 0) {
                    var score = Math.round((correctQuizzes / totalQuizzes) * 100);
                    SCORM.setScore(score);
                }
            }

            // ------------------------------------------------------------------
            // Completion
            // ------------------------------------------------------------------
            window.finishPage = function () {
                var answered = Object.keys(quizResults).length;
                if (answered < totalQuizzes) {
                    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã.");
                    return;
                }

                updateScore();
                SCORM.setLessonStatus("completed");
                SCORM.commit();
                SCORM.finish();

                var btn = document.getElementById('btnFinishPage');
                btn.textContent = "–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ ‚úì";
                btn.disabled = true;
                btn.classList.remove('primary');
                btn.classList.add('completed');

                // –í Multi-SCO LMS —Å–∞–º–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π (–∫–Ω–æ–ø–∫–∏ Next/Prev –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ LMS).
                // –ù–æ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
                alert("–†–∞–∑–¥–µ–ª –ø—Ä–æ–π–¥–µ–Ω! –í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É –≤ –º–µ–Ω—é –∫—É—Ä—Å–∞ (—Å–±–æ–∫—É –∏–ª–∏ —Å–≤–µ—Ä—Ö—É –≤ LMS).");
            };

            // Cleanup on unload
            window.addEventListener('beforeunload', function () {
                SCORM.finish();
            });

        })();
    </script>
</body>

</html>